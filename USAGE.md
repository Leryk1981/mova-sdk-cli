# MOVA SDK CLI â€“ Usage Guide

This guide complements the README with more detail on how the CLI works internally and how to extend it.

## Commands in depth

- `init [project]`
  - Creates `configs/`, `episodes/`, `plans/plan.sample.json`.
  - Safe to run in an existing empty directory; uses `.` when no project name is provided.

- `plan -s <schemaIdOrFile> <planFile>`
  - Uses `src/utils/validator.ts` which wraps `@leryk1981/mova-spec`.
  - Accepts a schema `$id` (e.g., `env.mova_agent_plan_v1.json`) or a direct file path.
  - Exit codes: `0` (valid), `2` (validation failed), `1` (runtime error).

- `run [--endpoint <url>] <planFile>`
  - Local mode: spawns `npx ts-node tools/mova-agent.ts --plan <file>`.
  - Remote mode: POSTs to MCP gateway endpoint; expects JSON body `{ plan: <object> }`.

- `driver:add <name>`
  - Generates `src/drivers/<name>.ts` with a class exposing `execute(input)`.
  - Prepends import and `registerDriver("<name>", <factory>)` to `src/drivers/index.ts`.

- `policy:set --role <role> --verb <verb> (--allow|--deny)` / `policy:show`
  - Reads/writes `configs/instruction_profile.default.json`.
  - If file is absent, bootstraps a default profile `{ rules: [], roles: ["admin","user","service"] }`.

- `episode:list [--verb <verb>] [--tool <toolId>]`
  - Scans `episodes/` for JSON files and prints `file: episode_id | verb`.

- `episode:export <episodeId> [--format json|csv] [--output <path>]`
  - Reads matching episode file, outputs to JSON (pretty) or CSV.

## Validator internals
`src/utils/validator.ts` loads schemas from `@leryk1981/mova-spec`. If the package is not present or a schema `$id` is missing, it falls back to loading by file path. Use `$id` values from the spec (see `examples/` in the spec package) for best compatibility.

## Adding schemas
- Place custom schemas in your project and reference them by path via `-s`.
- To extend `@leryk1981/mova-spec`, add schemas there and publish a new version, then update your CLI dependency.

## Project structure (generated by `init`)
```
configs/
  instruction_profile.default.json   # policies
episodes/                            # stored episodes
plans/
  plan.sample.json                   # sample plan
src/                                 # drivers, policies, etc. (if you write code)
```

## Troubleshooting quick refs
- Missing schema: install `@leryk1981/mova-spec` or provide a file path.
- Run with endpoint fails: verify URL, network access, and that server accepts `{ plan }` payload.
- Driver generation collision: remove/rename existing `src/drivers/<name>.ts` before re-generating.

## Links
- npm: https://www.npmjs.com/package/@leryk1981/mova-sdk-cli
- repo: https://github.com/Leryk1981/mova_agent/tree/main/sdk-cli
- spec: https://www.npmjs.com/package/@leryk1981/mova-spec
